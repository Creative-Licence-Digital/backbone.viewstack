/* backbone.viewstack - v0.0.3 - MIT */
/* Manage views & transitions in Backbone without the boilerplate */
/* https://github.com/Creative-Licence-Digital/backbone.viewstack */
var __hasProp={}.hasOwnProperty,__extends=function(t,s){function e(){this.constructor=t}for(var i in s)__hasProp.call(s,i)&&(t[i]=s[i]);return e.prototype=s.prototype,t.prototype=new e,t.__super__=s.prototype,t};!function(){"use strict";var t;return t="ontouchstart"in window,Backbone||"undefined"!=typeof console&&null!==console&&console.error("Ensure Backbone is included before backbone.viewstack"),Backbone.ViewStack=function(s){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,s),e.prototype.defaults={viewPath:"views/",headClass:".view-head",bodyClass:".view-body",ms:300},e.prototype.el="#views",e.prototype.views={},e.prototype.stack=[],e.prototype.preventTransition=!0,e.prototype.didFadeAndPush=!1,e.prototype.initialize=function(t){var s,e,i;i=_.extend({},this.defaults,t);for(s in i)e=i[s],this[s]=e;return this.viewPath||"undefined"!=typeof console&&null!==console&&console.error("Declare viewpath for views"),this},e.prototype.identify=function(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\//g,"-")+"-view"},e.prototype.create=function(t,s,e){var i;return null==e&&(e={}),null==e.el&&(e.el=$("<div class='view' id='"+this.identify(t)+"' />"),this.$el.append(e.el)),i=new s(e),i.__key=t,i.__head=i.$(this.headClass),i.__body=i.$(this.bodyClass),i.$el.hide(),this.views[t]=i},e.prototype.show=function(t,s){var e,i,n,o,r,a,h,l,d,c,u,p;if(null==s&&(s={}),n=s.key,null==n&&(n=t),null!=this.views[n])o=this.views[n];else if(h=require(this.viewPath+t),o=this.create(t,h,s),0===this.stack.length&&o.stack)for(u=o.stack,e=l=0,d=u.length;d>l;e=++l)c=u[e],c!==t&&(h=require(this.viewPath+c),a=this.create(c,h),a.$el.css({zIndex:e+1}),this.stack.push(a));return"function"==typeof o.show&&o.show(s),r=this.stack[this.stack.length-1],i=this.stack.indexOf(o)<0,(null!=r?null!=(p=r.stack)?p.indexOf(t):void 0:void 0)>-1&&(i=!1),s.transition?this.undelegateEvents():this.delegateEvents(),s.transition?(this.didFadeAndPush=!0,this.transform=this[""+s.transition+"Transform"]):this.didFadeAndPush||(this.didFadeAndPush=!1,this.transform=this.slideTransform),i||0===this.stack.length&&!this.preventTransition?this.pushView(o):(this.stack=this.stack.slice(0,this.stack.indexOf(o)+1).concat(r),1===this.stack.length&&this.stack.unshift(o),this.popView())},e.prototype.pushView=function(t){var s;return s=this.stack[this.stack.length-1],this.stack.push(t),this.activateCurrentView(s,!0)},e.prototype.popView=function(){return this.activateCurrentView(this.stack.pop(),!1)},e.prototype.activateCurrentView=function(t,s){var e,i;return e=this.stack[this.stack.length-1],this.cleanup(e.$el),this.preventTransition?(e.delegateEvents().$el.show().addClass("active"),null!=t&&t.$el.hide(),this.preventTransition=!1):t!==e?("function"==typeof(i=t.undelegateEvents()).hide&&i.hide(),t.$el.css({zIndex:this.stack.length+(s?-1:1)}),e.$el.css({zIndex:this.stack.length}),e.$el.show().addClass("active"),this.transitionView(e,!1),this.transitionView(t,!1),this.transform(t,0,!s),this.transform(e,this.endRatio(s),s),this.$el.get(0).offsetWidth,this.transitionView(e,!0),this.transitionView(t,!0),this.transform(e,0,!s),this.transform(t,this.endRatio(!s),!s),window.clearTimeout(this.transitionOutTimeout),this.transitionOutTimeout=window.setTimeout(function(s){return function(){return e.delegateEvents(),t.$el.hide().removeClass("active"),s.clearTransforms(e),s.clearTransforms(t)}}(this),this.ms+100)):void 0},e.prototype.cleanup=function(t){return window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=window.setTimeout(function(s){return function(){return t.hasClass("active")&&!s.slide?s.$(".view").not(t).hide().removeClass("active"):void 0}}(this),this.ms)},e.prototype.endRatio=function(t){return t?1:-.5},e.prototype.events=function(){var s;return s={},s[t?"touchstart":"mousedown"]="onStart",s[t?"touchmove":"mousemove"]="onMove",s[t?"touchend":"mouseup"]="onEnd",s[t?"touchcancel":"mouseleave"]="onEnd",s},e.prototype.onStart=function(s){var e,i,n,o,r,a;if(!(this.stack.length<2||s.target.nodeName.match(/INPUT|TEXTAREA/)))return r=t?s.touches[0]:s,n=this.$el.offset(),this.hasSlid=!1,this.transform=this.slideTransform,r.pageX-n.left<40?(o=this.stack[this.stack.length-1],e=(null!=(a=o.stack)?a.indexOf(o):void 0)-1,i=e>=0?this.views[prev.stack[e]]:this.stack[this.stack.length-2],o.$el.css({zIndex:this.stack.length}),i.$el.css({zIndex:this.stack.length-1}),this.slide={startX:r.pageX-n.left,startY:r.pageY,offset:n,prev:o,next:i},this.onMove(s)):void 0},e.prototype.onMove=function(s){var e;if(null!=this.slide)return"touchmove"===s.type&&s.preventDefault(),e=t?s.touches[0]:s,this.hasSlid||(Math.abs(e.pageX-this.slide.offset.left-this.slide.startX)>10?(this.hasSlid=!0,this.slide.prev.undelegateEvents(),this.slide.next.undelegateEvents(),this.transitionView(this.slide.prev,!1),this.transitionView(this.slide.next,!1),this.slide.next.$el.show(),this.slide.prev.$el.show()):Math.abs(e.pageY-this.slide.startY)>20&&this.onEnd()),this.hasSlid?(s.stopPropagation(),this.slide.ratio=Math.min(Math.max((e.pageX-this.slide.offset.left-this.slide.startX)/this.slide.offset.width,0),1),this.transform(this.slide.prev,this.slide.ratio,!0),this.transform(this.slide.next,.5*-(1-this.slide.ratio),!1)):void 0},e.prototype.onEnd=function(t){var s,e;if(null!=this.slide)return this.transitionView(this.slide.prev,!0),this.transitionView(this.slide.next,!0),this.hasSlid&&(t.stopPropagation(),s=this.slide.next,e=this.slide.prev,this.slide.ratio>.5?(this.transform(e,this.endRatio(!0),!0),this.transform(s,0,!0),this.preventTransition=!0,this.cleanup(this.slide.next.$el),window.clearTimeout(this.transitionEndTimeout),this.transitionEndTimeout=window.setTimeout(function(t){return function(){return t.isLinear?window.history.back():t.show(s.__key)}}(this),this.ms+100)):(this.transform(e,0,!1),this.transform(s,this.endRatio(!1),!1),this.cleanup(this.slide.prev.$el),e.delegateEvents())),this.slide=null},e.prototype.transitionView=function(t,s){var e;return e=s?"all "+this.ms+"ms":"none",t.__head.add(t.__body).css({"-webkit-transition":e,"-moz-transition":e,"-ms-transition":e,"-o-transition":e,transition:e})},e.prototype.slideTransform=function(t,s,e){var i;return t?(i="translate3d("+100*s+"%, 0, 0)",t.__body.css({"-webkit-transform":i,"-moz-transform":i,"-ms-transform":i,"-o-transform":i,transform:i,opacity:e?1:1+s}),t.__head.css({opacity:e?1-s:1})):void 0},e.prototype.zoomTransform=function(t,s,e){var i;return t?(i="translate3d(0, 0, 0) scale("+(1+.5*s)+")",t.__body.css({"-webkit-transform":i,"-moz-transform":i,"-ms-transform":i,"-o-transform":i,transform:i,opacity:e?1-s:1}),t.__head.css({opacity:e?1-s:1})):void 0},e.prototype.fadeTransform=function(t,s,e){return t?(t.__body.css({opacity:e?1-s:1}),t.__head.css({opacity:e?1-s:1})):void 0},e.prototype.clearTransforms=function(t){return t?(t.__body.css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:"",opacity:""}),t.__head.css({opacity:""})):void 0},e}(Backbone.View)}();