/* backbone.viewstack - v0.9.1 - MIT */
/* Manage views & transitions in Backbone without the boilerplate */
/* https://github.com/Creative-Licence-Digital/backbone.viewstack */
var __hasProp={}.hasOwnProperty,__extends=function(t,i){function s(){this.constructor=t}for(var e in i)__hasProp.call(i,e)&&(t[e]=i[e]);return s.prototype=i.prototype,t.prototype=new s,t.__super__=i.prototype,t};!function(){"use strict";var t;return t="ontouchstart"in window,Backbone||"undefined"!=typeof console&&null!==console&&console.error("Ensure Backbone is included before backbone.viewstack"),Backbone.ViewStack=function(i){function s(){return s.__super__.constructor.apply(this,arguments)}return __extends(s,i),s.prototype.defaults={viewPath:"views/",headClass:".view-head",bodyClass:".view-body",ms:300,overwrite:!0},s.prototype.el="#views",s.prototype.views={},s.prototype.stack=[],s.prototype.preventTransition=!0,s.prototype.willCustomPush=!1,s.prototype.initialize=function(t){var i,s,e;e=_.extend({},this.defaults,t);for(i in e)s=e[i],this[i]=s;return this.viewPath||"undefined"!=typeof console&&null!==console&&console.error("Declare viewpath for views"),this.overwrite&&this.$el.html(""),this},s.prototype.identify=function(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\//g,"-")+"-view"},s.prototype.create=function(t,i,s){var e,o;return null==s&&(s={}),e=s.key||t,null==s.el&&(s.el=$("<div class='view' id='"+this.identify(e)+"' />"),this.$el.append(s.el)),o=new i(s),o.__key=e,o.__head=o.$(this.headClass),o.__body=o.$(this.bodyClass),null==o.open&&(o.open=function(t){return function(i){return t.openView(o,i)}}(this)),null==o.exit&&(o.exit=function(t){return function(){return t.exitView(o)}}(this)),o.$el.hide(),this.views[e]=o},s.prototype.openView=function(t,i){return this.show(t.__key,i)},s.prototype.exitView=function(t){return this.stack.length>1&&this.stack[this.stack.length-1].__key===t.__key?this.isLinear?window.history.back():this.show(this.stack[this.stack.length-2].__key):void 0},s.prototype.show=function(t,i){var s,e,o,n,r,a,h,l,c,u,d,p;if(null==i&&(i={}),o=i.key||t,null!=this.views[o])n=this.views[o];else if(h=require(this.viewPath+t),n=this.create(t,h,i),0===this.stack.length&&n.stack)for(d=n.stack,s=l=0,c=d.length;c>l;s=++l)u=d[s],u!==t&&(h=require(this.viewPath+u),a=this.create(u,h),a.$el.css({zIndex:s+1}),this.stack.push(a));return"function"==typeof n.show&&n.show(i),r=this.stack[this.stack.length-1],e=this.stack.indexOf(n)<0,(null!=r?null!=(p=r.stack)?p.indexOf(t):void 0:void 0)>-1&&(e=!1),i.isDialog&&(this.willShowDialog=!0),i.transition?this.undelegateEvents():this.delegateEvents(),i.transition?(this.willCustomPush=!0,this.transform=this[""+i.transition+"Transform"]):this.willCustomPush||(this.willCustomPush=!1,this.transform=this.slideTransform),e||0===this.stack.length&&!this.preventTransition?this.pushView(n):(this.willShowDialog&&(r=this.removeDialog(n)||r),this.stack=this.stack.slice(0,this.stack.indexOf(n)+1).concat(r),1===this.stack.length&&this.stack.unshift(n),this.popView(),this.willHideDialog=!1,i.transition?void 0:this.willCustomPush=!1)},s.prototype.pushView=function(t){var i;return i=this.stack[this.stack.length-1],this.stack.push(t),this.activateCurrentView(i,!0)},s.prototype.popView=function(){return this.activateCurrentView(this.stack.pop(),!1)},s.prototype.removeDialog=function(t){return this.willShowDialog=!1,this.stack.indexOf(t)!==this.stack.length-2?(this.transform(this.stack.pop().undelegateEvents(),1,!0),this.transform=this.slideTransform,this.stack[this.stack.length-1]):void(this.willHideDialog=!0)},s.prototype.activateCurrentView=function(t,i){var s,e;return s=this.stack[this.stack.length-1],this.willShowDialog||this.cleanup(s.$el),this.preventTransition?(s.delegateEvents().$el.show().addClass("active"),null!=t&&t.$el.hide(),this.preventTransition=!1):t!==s?("function"==typeof(e=t.undelegateEvents()).hide&&e.hide(),t.$el.css({zIndex:this.stack.length+(i?-1:1)}),s.$el.css({zIndex:this.stack.length}),s.$el.show().addClass("active"),this.transitionView(s,!1),this.transitionView(t,!1),this.willShowDialog||this.transform(t,0,!i),this.willHideDialog||this.transform(s,this.endRatio(i),i),this.$el.get(0).offsetWidth,this.transitionView(s,!0),this.transform(s,0,!i),this.willShowDialog||(this.transitionView(t,!0),this.transform(t,this.endRatio(!i),!i)),window.clearTimeout(this.transitionOutTimeout),this.transitionOutTimeout=window.setTimeout(function(i){return function(){return s.delegateEvents(),t.$el.removeClass("active"),i.willShowDialog||t.$el.hide(),i.clearTransforms(s),i.clearTransforms(t)}}(this),this.ms+100)):void 0},s.prototype.cleanup=function(t){return window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=window.setTimeout(function(i){return function(){return t.hasClass("active")&&!i.slide?(i.$(".view").not(t).hide().removeClass("active"),t.show().addClass("active")):void 0}}(this),this.ms)},s.prototype.endRatio=function(t){return t?1:-.5},s.prototype.events=function(){var i;return i={},i[t?"touchstart":"mousedown"]="onStart",i[t?"touchmove":"mousemove"]="onMove",i[t?"touchend":"mouseup"]="onEnd",i[t?"touchcancel":"mouseleave"]="onEnd",i},s.prototype.onStart=function(i){var s,e,o,n,r,a;return n=this.stack[this.stack.length-1],s=(null!=(a=n.stack)?a.indexOf(n.__key):void 0)>0,this.stack.length<2&&!s||i.target.nodeName.match(/INPUT|TEXTAREA/)?void 0:(r=t?i.touches[0]:i,null==this.offset&&(this.offset=this.$el.offset()),this.hasSlid=!1,r.pageX-this.offset.left<40?(s?(e=n.stack.indexOf(n.__key)-1,o=this.views[n.stack[e]]):o=this.stack[this.stack.length-2],n.$el.css({zIndex:this.stack.length}),o.$el.css({zIndex:this.stack.length-1}),this.slide={startX:r.pageX-this.offset.left,startY:r.pageY,prev:n,next:o},this.onMove(i)):void 0)},s.prototype.onMove=function(i){var s;if(null!=this.slide)return"touchmove"===i.type&&i.preventDefault(),s=t?i.touches[0]:i,this.hasSlid||(Math.abs(s.pageX-this.offset.left-this.slide.startX)>10?(this.hasSlid=!0,this.slide.prev.undelegateEvents(),this.slide.next.undelegateEvents(),this.transitionView(this.slide.prev,!1),this.transitionView(this.slide.next,!1),this.transform=this.slideTransform,this.slide.next.$el.show(),this.slide.prev.$el.show()):Math.abs(s.pageY-this.slide.startY)>20&&this.onEnd()),this.hasSlid?(i.stopPropagation(),this.slide.ratio=Math.min(Math.max((s.pageX-this.offset.left-this.slide.startX)/this.offset.width,0),1),this.transform(this.slide.prev,this.slide.ratio,!0),this.transform(this.slide.next,.5*-(1-this.slide.ratio),!1)):void 0},s.prototype.onEnd=function(t){var i,s;if(null!=this.slide)return this.transitionView(this.slide.prev,!0),this.transitionView(this.slide.next,!0),this.hasSlid&&(t.stopPropagation(),i=this.slide.next,s=this.slide.prev,this.slide.ratio>.5?(this.transform(s,this.endRatio(!0),!0),this.transform(i,0,!0),this.preventTransition=!0,this.cleanup(this.slide.next.$el),this.undelegateEvents(),window.clearTimeout(this.transitionEndTimeout),this.transitionEndTimeout=window.setTimeout(function(t){return function(){return t.isLinear?(window.history.back(),t.delegateEvents()):t.show(i.__key)}}(this),this.ms+100)):(this.transform(s,0,!1),this.transform(i,this.endRatio(!1),!1),this.cleanup(this.slide.prev.$el),s.delegateEvents())),this.slide=null},s.prototype.transitionView=function(t,i){var s;return s=i?"all "+this.ms+"ms":"none",t.__head.add(t.__body).css({"-webkit-transition":s,"-moz-transition":s,"-ms-transition":s,"-o-transition":s,transition:s})},s.prototype.slideTransform=function(t,i,s){var e;return t?(e="translate3d("+100*i+"%, 0, 0)",t.__body.css({"-webkit-transform":e,"-moz-transform":e,"-ms-transform":e,"-o-transform":e,transform:e,opacity:s?1:1+i}),t.__head.css({opacity:s?1-i:1})):void 0},s.prototype.zoomTransform=function(t,i,s){var e;return t?(e="translate3d(0, 0, 0) scale("+(1+.25*i)+")",t.__body.css({"-webkit-transform":e,"-moz-transform":e,"-ms-transform":e,"-o-transform":e,transform:e,opacity:s?1-i:1}),t.__head.css({opacity:s?1-i:1})):void 0},s.prototype.fadeTransform=function(t,i,s){return t?(t.__body.css({opacity:s?1-i:1}),t.__head.css({opacity:s?1-i:1})):void 0},s.prototype.clearTransforms=function(t){return t?(t.__body.css({"-webkit-transform":"","-moz-transform":"","-ms-transform":"","-o-transform":"",transform:"",opacity:""}),t.__head.css({opacity:""})):void 0},s}(Backbone.View)}();