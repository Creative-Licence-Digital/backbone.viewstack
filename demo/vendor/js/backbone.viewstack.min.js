/* backbone.viewstack - v0.0.1 - MIT */
/* Manage views & transitions without the boilerplate */
/* https://github.com/Creative-Licence-Digital/backbone.viewstack */
var __bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var s in e)__hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};!function(){"use strict";var t;return t="ontouchstart"in window,Backbone||"undefined"!=typeof console&&null!==console&&console.error("Ensure Backbone is included before backbone.viewstack"),Backbone.ViewStack=function(e){function i(){return this.create=__bind(this.create,this),i.__super__.constructor.apply(this,arguments)}return __extends(i,e),i.prototype.el="#views",i.prototype.views={},i.prototype.stack=[],i.prototype.preventPush=!0,i.prototype.initialize=function(t){return t.viewPath||"undefined"!=typeof console&&null!==console&&console.error("Declare viewpath for views"),this.viewPath=t.viewPath,this.headClass=t.headClass||".view-head",this.bodyClass=t.bodyClass||".view-body",this},i.prototype.identify=function(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase().replace(/\//g,"-")+"-view"},i.prototype.create=function(t,e,i){var s;return null==i&&(i={}),null==i.el&&(i.el=$("<div class='view' id='"+this.identify(t)+"' />"),this.$el.append(i.el)),s=new e(i),s.$el.hide(),this.views[t]=s},i.prototype.show=function(t,e){var i,s,n,o,r,a,h,l,u,c,d,w;if(null==e&&(e={}),s=e.key,null==s&&(s=t),null!=this.views[s])n=this.views[s];else if(h=require(this.viewPath+t),n=this.create(t,h,e),0===this.stack.length&&n.stack)for(d=n.stack,i=l=0,u=d.length;u>l;i=++l)c=d[i],c!==t&&(h=require(this.viewPath+c),a=this.create(c,h),a.$el.css({zIndex:i+1}),this.stack.push(a));return"function"==typeof n.show&&n.show(e),o=this.stack.slice(-1)[0],r=this.stack.indexOf(n)<0,(null!=o?null!=(w=o.stack)?w.indexOf(t):void 0:void 0)>-1&&(r=!1),r&&!this.preventPush||0===this.stack.length?this.pushView(n):(this.stack=this.stack.slice(0,this.stack.indexOf(n)+1).concat(o),1===this.stack.length&&this.stack.unshift(n),this.popView())},i.prototype.pushView=function(t){var e;return e=this.stack.slice(-1)[0],this.stack.push(t),this.activateCurrentView(e,!0)},i.prototype.popView=function(){return this.activateCurrentView(this.stack.pop(),!1)},i.prototype.activateCurrentView=function(t,e){var i,s;return i=this.stack.slice(-1)[0],this.preventPush?(i.delegateEvents().$el.show(),null!=t&&t.$el.hide(),this.preventPush=!1):t!==i?("function"==typeof(s=t.undelegateEvents()).hide&&s.hide(),t.$el.css({zIndex:this.stack.length+(e?-1:1)}),i.$el.css({zIndex:this.stack.length}),i.$el.show().addClass("active"),this.transitionView({view:i},!1),this.transitionView({view:t},!1),this.transformView({view:t},0,!e),this.transformView({view:i},this.endRatio(e),e),window.clearTimeout(this.transitionInTimeout),this.transitionInTimeout=window.setTimeout(function(s){return function(){return s.transitionView({view:i},!0),s.transitionView({view:t},!0),s.transformView({view:i},0,!e),s.transformView({view:t},s.endRatio(!e),!e),window.clearTimeout(s.transitionOutTimeout),s.transitionOutTimeout=window.setTimeout(function(){return i.delegateEvents(),t.$el.hide().removeClass("active")},300)}}(this),10)):void 0},i.prototype.endRatio=function(t){return t?1:-.5},i.prototype.events=function(){var e;return e={},e[t?"touchstart":"mousedown"]="onStart",e[t?"touchmove":"mousemove"]="onMove",e[t?"touchend":"mouseup"]="onEnd",e[t?"touchcancel":"mouseleave"]="onEnd",e},i.prototype.onStart=function(e){var i,s,n,o;if(!(this.stack.length<2||e.target.nodeName.match(/INPUT|TEXTAREA/)))return o=t?e.touches[0]:e,s=this.$el.offset(),this.hasSlid=!1,o.pageX-s.left<40&&this.stack.length>1?(n=this.stack.slice(-1)[0],i=this.stack.slice(-2,-1)[0],this.slide={startX:o.pageX-s.left,startY:o.pageY,offset:s,prev:{view:n,viewHead:n.$(this.headClass),viewBody:n.$(this.bodyClass)},next:{view:i,viewHead:i.$(this.headClass),viewBody:i.$(this.bodyClass)}},this.onMove(e)):void 0},i.prototype.onMove=function(e){var i;if(!(null==this.slide||this.stack.length<2))return"touchmove"===e.type&&e.preventDefault(),i=t?e.touches[0]:e,this.hasSlid||(Math.abs(i.pageX-this.slide.offset.left-this.slide.startX)>10?(this.hasSlid=!0,this.slide.prev.view.undelegateEvents(),this.slide.next.view.undelegateEvents(),this.transitionView(this.slide.prev,!1),this.transitionView(this.slide.next,!1),this.slide.next.view.$el.show(),this.slide.prev.view.$el.show()):Math.abs(i.pageY-this.slide.startY)>20&&this.onEnd()),this.hasSlid?(e.stopPropagation(),this.slide.ratio=Math.min(Math.max((i.pageX-this.slide.offset.left-this.slide.startX)/this.slide.offset.width,0),1),this.transformView(this.slide.prev,this.slide.ratio,!0),this.transformView(this.slide.next,.5*-(1-this.slide.ratio),!1)):void 0},i.prototype.onEnd=function(t){var e,i;if(!(null==this.slide||this.stack.length<2))return this.transitionView(this.slide.prev,!0),this.transitionView(this.slide.next,!0),this.hasSlid&&(t.stopPropagation(),e=this.slide.next,i=this.slide.prev,this.slide.ratio>.5?(this.transformView(i,this.endRatio(!0),!0),this.transformView(e,0,!0),this.preventPush=!0,window.clearTimeout(this.transitionEndTimeout),this.transitionEndTimeout=window.setTimeout(function(){return function(){return window.history.back()}}(this),400)):(this.transformView(i,0,!1),this.transformView(e,this.endRatio(!1),!1),i.view.delegateEvents())),this.slide=null},i.prototype.transitionView=function(t,e){var i,s,n,o;return s=t.view,o=t.viewHead,n=t.viewBody,i=e?"all 300ms":"none",(n||s.$(this.bodyClass)).add(o||s.$(this.headClass)).css({"-webkit-transition":i,"-moz-transition":i,"-ms-transition":i,"-o-transition":i,transition:i})},i.prototype.transformView=function(t,e,i){var s,n,o,r;return n=t.view,r=t.viewHead,o=t.viewBody,n?(s="translate3d("+100*e+"%, 0, 0)",(o||n.$(this.bodyClass)).css({"-webkit-transform":s,"-moz-transform":s,"-ms-transform":s,"-o-transform":s,transform:s,opacity:i?1:1+e}),(r||n.$(this.headClass)).css({opacity:i?1-e:1})):void 0},i}(Backbone.View)}();